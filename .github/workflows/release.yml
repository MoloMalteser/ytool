name: Build and Release XTool

on:
  push:
    tags:
      - "*"

jobs:
  # ------------------------------
  # Linux Build
  # ------------------------------
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        host:
          - runner: ubuntu-24.04
            arch: x86_64
          - runner: ubuntu-24.04-arm
            arch: aarch64
    runs-on: ${{ matrix.host.runner }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux package
        run: |
          docker compose run --build \
            -e XTOOL_VERSION=${{ github.ref_name }} \
            --rm xtool Linux/build.sh

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: xtool-${{ matrix.host.arch }}
          path: |
            Linux/packages/xtool-${{ matrix.host.arch }}.AppImage
            Linux/packages/xtool-${{ matrix.host.arch }}.AppImage.zsync

  # ------------------------------
  # macOS Build
  # ------------------------------
  build-mac:
    runs-on: macos-26
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: macOS
          ruby-version: 3.4
          bundler-cache: true

      - name: Install Homebrew dependencies
        run: |
          brew update
          brew install xcodegen

      - name: Build macOS package
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          IDENTITY_P12: ${{ secrets.IDENTITY_P12 }}
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
          XTOOL_VERSION: ${{ github.ref_name }}
        run: |
          cd macOS
          bundle exec fastlane package

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xtool-mac
          path: |
            macOS/Build/Output/xtool.app.zip
            macOS/Build/Output/xtool.app.dSYM.zip

  # ------------------------------
  # Release
  # ------------------------------
  release:
    needs: [build-linux, build-mac]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: xtool-*
          path: output

      - name: Create and publish release
        run: |
          TAG="${{ github.ref_name }}"
          gh release create "$TAG" --draft --title "v$TAG"
          gh release upload "$TAG" output/**/*.{AppImage,AppImage.zsync,app.zip,app.dSYM.zip}
