require_relative "spaceship_patch"

default_platform(:mac)

ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"

lane :package do
  # 1️⃣ Xcode-Projekt generieren
  xcodegen

  # 2️⃣ Keychain- / Zertifikat-Schritte überspringen
  # create_keychain, unlock_keychain, import_certificate -> entfällt

  # 3️⃣ Sigh / Code-Signing überspringen
  # update_code_signing_settings -> entfällt
  # gym / export_method -> direkt mit xcodebuild bauen

  sh("xcodebuild",
     "-project", "XToolMac.xcodeproj",
     "-scheme", "XToolMac",
     "-configuration", "Release",
     "-derivedDataPath", "./Build/DerivedData",
     "BUILD_DIR=./Build/Output",
     "CODE_SIGN_IDENTITY=" # Keine Signierung
  )

  # 4️⃣ Notarization überspringen
  # notarize -> entfällt

  # 5️⃣ App zippen wie zuvor
  sh(
    "ditto", "-c", "-k", "--keepParent", "--sequesterRsrc",
    "./Build/Output/Release/XToolMac.app", "./Build/Output/XToolMac.app.zip",
  )

  puts "✅ Build erfolgreich! Die App liegt in ./Build/Output"
end
